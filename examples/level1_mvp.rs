//! # FROST 3-of-5 é–€æª»ç°½ç« æœå‹™ - MVP å¯¦ä½œ
//!
//! é€™å€‹ç¨‹å¼ç¤ºç¯„äº†å¦‚ä½•ä½¿ç”¨ FROST (Flexible Round-Optimized Schnorr Threshold) å”è­°
//! ä¾†å¯¦ç¾ä¸€å€‹åˆ†æ•£å¼é–€æª»ç°½ç« ç³»çµ±ã€‚åœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘æ¨¡æ“¬äº†ä¸€å€‹ 3-of-5 çš„é…ç½®ï¼š
//! - ç¸½å…±æœ‰ 5 å€‹ç°½ç½²è€… (signers)
//! - éœ€è¦è‡³å°‘ 3 å€‹ç°½ç½²è€…åˆä½œæ‰èƒ½ç”Ÿæˆæœ‰æ•ˆç°½ç« 
//!
//! ## FROST å”è­°å„ªå‹¢
//! - åªéœ€è¦ 2 è¼ªé€šè¨Šï¼ˆç›¸æ¯”å‚³çµ± TSS éœ€è¦æ›´å¤šè¼ªï¼‰
//! - ä½¿ç”¨ Schnorr ç°½ç« ï¼ˆèˆ‡æ¯”ç‰¹å¹£ Taproot ç›¸å®¹ï¼‰
//! - æœ€çµ‚ç°½ç« èˆ‡å–®ä¸€ç°½ç½²è€…çš„ç°½ç« ç„¡æ³•å€åˆ†ï¼ˆéš±ç§æ€§ï¼‰

use anyhow::{Context, Result};
use frost_secp256k1 as frost;
use rand::thread_rng;
use std::collections::HashMap;

// ============================================================================
// å‹åˆ¥åˆ¥å - æé«˜ç¨‹å¼ç¢¼å¯è®€æ€§
// ============================================================================

/// ç°½ç½²è€…çš„å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆ1-basedï¼Œä¾‹å¦‚ï¼š1, 2, 3, 4, 5ï¼‰
type SignerId = frost::Identifier;

/// ç°½ç½²è€…çš„å¯†é‘°åˆ†ç‰‡ - æ¯å€‹ç°½ç½²è€…æŒæœ‰ä¸€å€‹åˆ†ç‰‡ï¼Œç„¡æ³•å–®ç¨ä½¿ç”¨
type KeyShare = frost::keys::KeyPackage;

/// Nonce æ‰¿è«¾ - Round 1 ä¸­ç°½ç½²è€…ç”Ÿæˆçš„å…¬é–‹æ‰¿è«¾
type SigningCommitments = frost::round1::SigningCommitments;

/// Nonce ç§˜å¯† - Round 1 ä¸­ç°½ç½²è€…ç”Ÿæˆçš„ç§˜å¯†éƒ¨åˆ†ï¼Œå¿…é ˆå®‰å…¨å„²å­˜
type SigningNonces = frost::round1::SigningNonces;

/// ç°½ç« åˆ†ç‰‡ - Round 2 ä¸­æ¯å€‹ç°½ç½²è€…ç”Ÿæˆçš„éƒ¨åˆ†ç°½ç« 
type SignatureShare = frost::round2::SignatureShare;

// ============================================================================
// ä¸»ç¨‹å¼æµç¨‹
// ============================================================================

fn main() -> Result<()> {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘   FROST 3-of-5 é–€æª»ç°½ç« æœå‹™ - å®Œæ•´ç”Ÿå‘½é€±æœŸç¤ºç¯„                â•‘");
    println!("â•‘   Bitcoin-Compatible Schnorr Threshold Signatures             â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // ------------------------------------------------------------------------
    // éšæ®µ 0: è¨­å®šåƒæ•¸
    // ------------------------------------------------------------------------
    let max_signers = 5; // ç¸½å…±çš„ç°½ç½²è€…æ•¸é‡
    let min_signers = 3; // ç”Ÿæˆç°½ç« æ‰€éœ€çš„æœ€å°‘ç°½ç½²è€…æ•¸é‡

    println!("ğŸ“‹ é…ç½®åƒæ•¸:");
    println!("   â€¢ æœ€å¤§ç°½ç½²è€…æ•¸: {}", max_signers);
    println!("   â€¢ é–€æª»å€¼ (threshold): {}", min_signers);
    println!("   â€¢ å”è­°: FROST with secp256k1 (Bitcoin-compatible)\n");

    // ------------------------------------------------------------------------
    // éšæ®µ 1: é‡‘é‘°ç”Ÿæˆ (Trusted Dealer Setup)
    // ------------------------------------------------------------------------
    // åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œæ‡‰è©²ä½¿ç”¨åˆ†æ•£å¼é‡‘é‘°ç”Ÿæˆ (DKG) ä¾†é¿å…å–®é»ä¿¡ä»»ã€‚
    // ä½†ç‚ºäº†ç°¡åŒ– MVPï¼Œæˆ‘å€‘ä½¿ç”¨ "trusted dealer" æ–¹æ³•ï¼š
    // ä¸€å€‹å—ä¿¡ä»»çš„å¯¦é«”ç”Ÿæˆæ‰€æœ‰é‡‘é‘°åˆ†ç‰‡ï¼Œç„¶å¾Œåˆ†ç™¼çµ¦å„å€‹ç°½ç½²è€…ã€‚
    println!("ğŸ”‘ éšæ®µ 1: é‡‘é‘°ç”Ÿæˆ (Trusted Dealer Setup)");
    println!("   âš ï¸  æ³¨æ„: ç”Ÿç”¢ç’°å¢ƒæ‡‰ä½¿ç”¨ DKG (Distributed Key Generation) é¿å…å–®é»ä¿¡ä»»\n");

    let mut rng = thread_rng();

    // ç”Ÿæˆé‡‘é‘°åˆ†ç‰‡
    let (shares, pubkey_package) = frost::keys::generate_with_dealer(
        max_signers,
        min_signers,
        frost::keys::IdentifierList::Default,
        &mut rng,
    )
    .context("é‡‘é‘°ç”Ÿæˆå¤±æ•—")?;

    // å°‡é‡‘é‘°åˆ†ç‰‡å„²å­˜åœ¨ HashMap ä¸­ï¼ˆæ¨¡æ“¬åˆ†ç™¼çµ¦ä¸åŒçš„ç°½ç½²è€…ï¼‰
    let mut key_packages: HashMap<SignerId, KeyShare> = HashMap::new();
    for (identifier, share) in shares {
        println!("   âœ“ å·²ç”Ÿæˆç°½ç½²è€… {} çš„é‡‘é‘°åˆ†ç‰‡", identifier);
        key_packages.insert(identifier, share);
    }

    // é¡¯ç¤ºç¾¤çµ„å…¬é‘° - é€™æ˜¯ç”¨æ–¼é©—è­‰æœ€çµ‚ç°½ç« çš„å…¬é‘°
    let group_pubkey = pubkey_package.verifying_key();
    println!("\n   ğŸ“¢ ç¾¤çµ„å…¬é‘° (Group Public Key):");
    println!("      {}\n", hex::encode(group_pubkey.serialize()));
    println!("   ğŸ’¡ é€™å€‹å…¬é‘°å¯ä»¥å…¬é–‹ï¼Œç”¨æ–¼é©—è­‰é–€æª»ç°½ç« \n");

    // ------------------------------------------------------------------------
    // éšæ®µ 2: é¸æ“‡ç°½ç½²è€…ä¸¦é–‹å§‹ç°½ç« æµç¨‹
    // ------------------------------------------------------------------------
    // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™å¯èƒ½æ˜¯å‹•æ…‹é¸æ“‡çš„ï¼ˆä¾‹å¦‚ï¼šæ ¹æ“šå¯ç”¨æ€§ï¼‰
    // é€™è£¡æˆ‘å€‘é¸æ“‡ç°½ç½²è€… 1, 2, 3
    println!("ğŸ‘¥ éšæ®µ 2: é¸æ“‡åƒèˆ‡ç°½ç« çš„ç°½ç½²è€…");

    let signer_ids: Vec<SignerId> = key_packages.keys().take(min_signers as usize).copied().collect();
    println!("   é¸å®šçš„ç°½ç½²è€…: {:?}\n", signer_ids);

    // è¦ç°½ç½²çš„è¨Šæ¯ - åœ¨æ¯”ç‰¹å¹£å ´æ™¯ä¸­ï¼Œé€™é€šå¸¸æ˜¯äº¤æ˜“é›œæ¹Š
    let message = b"Transfer 1.5 BTC to bc1q... (tx_hash: 0xabcd1234...)";
    println!("ğŸ“ è¦ç°½ç½²çš„è¨Šæ¯:");
    println!("   ã€Œ{}ã€", String::from_utf8_lossy(message));
    println!("   è¨Šæ¯é›œæ¹Š: {}\n", hex::encode(&message[..32.min(message.len())]));

    // ------------------------------------------------------------------------
    // éšæ®µ 3: Round 1 - Nonce ç”Ÿæˆèˆ‡æ‰¿è«¾
    // ------------------------------------------------------------------------
    // æ¯å€‹ç°½ç½²è€…ç”Ÿæˆéš¨æ©Ÿ nonce ä¸¦å‰µå»ºæ‰¿è«¾ã€‚
    //
    // ç‚ºä»€éº¼éœ€è¦ nonce æ‰¿è«¾ï¼Ÿ
    // - é˜²æ­¢æƒ¡æ„ç°½ç½²è€…åœ¨çœ‹åˆ°å…¶ä»–äººçš„ nonce å¾Œèª¿æ•´è‡ªå·±çš„ nonce
    // - ç¢ºä¿ç°½ç« çš„ä¸å¯å½é€ æ€§ï¼ˆEUF-CMA å®‰å…¨æ€§ï¼‰
    // - æ‰¿è«¾-æ­éœ² (commit-reveal) æ¨¡å¼æ˜¯å¯†ç¢¼å­¸å”è­°ä¸­çš„å¸¸è¦‹æŠ€è¡“
    println!("ğŸ² éšæ®µ 3: Round 1 - Nonce ç”Ÿæˆèˆ‡æ‰¿è«¾");
    println!("   ğŸ’¡ æ¯å€‹ç°½ç½²è€…ç”Ÿæˆéš¨æ©Ÿ nonce ä¸¦å‰µå»ºå…¬é–‹æ‰¿è«¾\n");

    let mut nonces_map: HashMap<SignerId, SigningNonces> = HashMap::new();
    let mut commitments_map: HashMap<SignerId, SigningCommitments> = HashMap::new();

    for signer_id in &signer_ids {
        // ç”Ÿæˆç°½ç«  nonceï¼ˆåŒ…å«ç§˜å¯†éƒ¨åˆ†å’Œå…¬é–‹æ‰¿è«¾ï¼‰
        let (nonces, commitments) = frost::round1::commit(
            key_packages.get(signer_id).unwrap().signing_share(),
            &mut rng,
        );

        println!("   ç°½ç½²è€… {}:", signer_id);
        println!("      â€¢ å·²ç”Ÿæˆç§˜å¯† nonce (ä¿å¯†å„²å­˜)");
        println!("      â€¢ å·²ç”Ÿæˆå…¬é–‹æ‰¿è«¾: {}...{}",
                 &hex::encode(commitments.serialize())[..16],
                 &hex::encode(commitments.serialize())[48..64]);

        // ç§˜å¯† nonce å¿…é ˆå®‰å…¨å„²å­˜ï¼ˆåœ¨ç”Ÿç”¢ç’°å¢ƒä¸­æ‡‰è©²åŠ å¯†ï¼‰
        nonces_map.insert(*signer_id, nonces);

        // å…¬é–‹æ‰¿è«¾å¯ä»¥å‚³é€çµ¦å”èª¿è€…
        commitments_map.insert(*signer_id, commitments);
    }

    println!("\n   âœ“ Round 1 å®Œæˆï¼šæ‰€æœ‰ç°½ç½²è€…å·²æäº¤æ‰¿è«¾\n");

    // ------------------------------------------------------------------------
    // éšæ®µ 4: å”èª¿è€…å»ºç«‹ç°½ç« å¥—ä»¶ (Signing Package)
    // ------------------------------------------------------------------------
    // å”èª¿è€…æ”¶é›†æ‰€æœ‰å…¬é–‹æ‰¿è«¾å’Œè¨Šæ¯ï¼Œå‰µå»ºä¸€å€‹ SigningPackageã€‚
    // é€™å€‹å¥—ä»¶å°‡è¢«åˆ†ç™¼çµ¦æ‰€æœ‰åƒèˆ‡çš„ç°½ç½²è€…ç”¨æ–¼ Round 2ã€‚
    println!("ğŸ“¦ éšæ®µ 4: å”èª¿è€…å»ºç«‹ç°½ç« å¥—ä»¶ (Signing Package)");

    let signing_package = frost::SigningPackage::new(commitments_map.clone(), message);

    println!("   âœ“ å”èª¿è€…å·²æ”¶é›† {} å€‹æ‰¿è«¾", commitments_map.len());
    println!("   âœ“ ç°½ç« å¥—ä»¶å·²å»ºç«‹ä¸¦æº–å‚™åˆ†ç™¼çµ¦ç°½ç½²è€…\n");

    // ------------------------------------------------------------------------
    // éšæ®µ 5: Round 2 - ç”Ÿæˆç°½ç« åˆ†ç‰‡
    // ------------------------------------------------------------------------
    // æ¯å€‹ç°½ç½²è€…ä½¿ç”¨ä»¥ä¸‹è³‡æ–™ç”Ÿæˆè‡ªå·±çš„ç°½ç« åˆ†ç‰‡ï¼š
    // 1. è‡ªå·±çš„é‡‘é‘°åˆ†ç‰‡ (key share)
    // 2. è‡ªå·±çš„ç§˜å¯† nonce
    // 3. å”èª¿è€…æä¾›çš„ç°½ç« å¥—ä»¶
    println!("âœï¸  éšæ®µ 5: Round 2 - ç”Ÿæˆç°½ç« åˆ†ç‰‡");
    println!("   ğŸ’¡ æ¯å€‹ç°½ç½²è€…ç¨ç«‹è¨ˆç®—è‡ªå·±çš„ç°½ç« åˆ†ç‰‡\n");

    let mut signature_shares: HashMap<SignerId, SignatureShare> = HashMap::new();

    for signer_id in &signer_ids {
        let key_package = key_packages.get(signer_id).unwrap();
        let nonces = nonces_map.get(signer_id).unwrap();

        // ç”Ÿæˆç°½ç« åˆ†ç‰‡
        let signature_share = frost::round2::sign(&signing_package, nonces, key_package)
            .context(format!("ç°½ç½²è€… {} ç”Ÿæˆç°½ç« åˆ†ç‰‡å¤±æ•—", signer_id))?;

        println!("   ç°½ç½²è€… {}:", signer_id);
        println!("      â€¢ ä½¿ç”¨é‡‘é‘°åˆ†ç‰‡ + ç§˜å¯† nonce + ç°½ç« å¥—ä»¶");
        println!("      â€¢ å·²ç”Ÿæˆç°½ç« åˆ†ç‰‡: {}...",
                 &hex::encode(signature_share.serialize())[..32]);

        signature_shares.insert(*signer_id, signature_share);
    }

    println!("\n   âœ“ Round 2 å®Œæˆï¼šå·²æ”¶é›† {} å€‹ç°½ç« åˆ†ç‰‡\n", signature_shares.len());

    // ------------------------------------------------------------------------
    // éšæ®µ 6: èšåˆç°½ç«  (Signature Aggregation)
    // ------------------------------------------------------------------------
    // å”èª¿è€…æ”¶é›†æ‰€æœ‰ç°½ç« åˆ†ç‰‡ä¸¦èšåˆæˆæœ€çµ‚çš„ Schnorr ç°½ç« ã€‚
    // é€™å€‹èšåˆéç¨‹æ˜¯ FROST çš„é—œéµå‰µæ–°ï¼š
    // - æœ€çµ‚ç°½ç« èˆ‡å–®ä¸€ç°½ç½²è€…çš„ Schnorr ç°½ç« æ ¼å¼å®Œå…¨ç›¸åŒ
    // - å¤–éƒ¨è§€å¯Ÿè€…ç„¡æ³•åˆ†è¾¨é€™æ˜¯é–€æª»ç°½ç« é‚„æ˜¯å–®ä¸€ç°½ç« ï¼ˆéš±ç§æ€§ï¼‰
    println!("ğŸ”— éšæ®µ 6: èšåˆç°½ç«  (Signature Aggregation)");

    let group_signature = frost::aggregate(
        &signing_package,
        &signature_shares,
        &pubkey_package,
    )
    .context("ç°½ç« èšåˆå¤±æ•—")?;

    println!("   âœ“ å·²æˆåŠŸèšåˆ {} å€‹ç°½ç« åˆ†ç‰‡", signature_shares.len());
    println!("\n   ğŸ‰ æœ€çµ‚ç°½ç«  (Final Signature):");
    println!("      {}\n", hex::encode(group_signature.serialize()));
    println!("   ğŸ’¡ é€™æ˜¯ä¸€å€‹æ¨™æº–çš„ Schnorr ç°½ç« ï¼Œèˆ‡å–®ä¸€ç°½ç½²è€…çš„ç°½ç« ç„¡æ³•å€åˆ†\n");

    // ------------------------------------------------------------------------
    // éšæ®µ 7: é©—è­‰ç°½ç« 
    // ------------------------------------------------------------------------
    // ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ç¾¤çµ„å…¬é‘°ä¾†é©—è­‰é€™å€‹ç°½ç« ã€‚
    // é©—è­‰éç¨‹èˆ‡é©—è­‰æ™®é€šçš„ Schnorr ç°½ç« å®Œå…¨ç›¸åŒã€‚
    println!("âœ… éšæ®µ 7: é©—è­‰ç°½ç« ");

    let verification_result = group_pubkey.verify(message, &group_signature);

    match verification_result {
        Ok(_) => {
            println!("   ğŸŠ ç°½ç« é©—è­‰æˆåŠŸï¼");
            println!("   âœ“ è¨Šæ¯ç¢ºå¯¦ç”±è‡³å°‘ {} å€‹ç°½ç½²è€…å…±åŒç°½ç½²", min_signers);
            println!("   âœ“ ç°½ç« å°æ‡‰çš„ç¾¤çµ„å…¬é‘°: {}...",
                     &hex::encode(group_pubkey.serialize())[..32]);
        }
        Err(e) => {
            println!("   âŒ ç°½ç« é©—è­‰å¤±æ•—: {:?}", e);
            return Err(anyhow::anyhow!("ç°½ç« é©—è­‰å¤±æ•—"));
        }
    }

    // ------------------------------------------------------------------------
    // ç¸½çµ
    // ------------------------------------------------------------------------
    println!("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘   âœ… FROST å”è­°å®Œæ•´ç”Ÿå‘½é€±æœŸåŸ·è¡ŒæˆåŠŸ                            â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!("\nğŸ“Š åŸ·è¡Œæ‘˜è¦:");
    println!("   â€¢ ç¸½ç°½ç½²è€…æ•¸: {}", max_signers);
    println!("   â€¢ åƒèˆ‡ç°½ç½²è€…æ•¸: {}", min_signers);
    println!("   â€¢ é€šè¨Šè¼ªæ¬¡: 2 (FROST çš„é—œéµå„ªå‹¢)");
    println!("   â€¢ ç°½ç« é¡å‹: Schnorr (secp256k1)");
    println!("   â€¢ ç°½ç« é©—è­‰: âœ“ é€šé\n");

    println!("ğŸ¯ ä¸‹ä¸€æ­¥:");
    println!("   1. å°‡æ­¤å–®é«”ç¨‹å¼é‡æ§‹ç‚º HTTP API æ¶æ§‹ (Axum/Tokio)");
    println!("   2. å¯¦ä½œåˆ†æ•£å¼é‡‘é‘°ç”Ÿæˆ (DKG) å–ä»£ trusted dealer");
    println!("   3. åŠ å…¥æŒä¹…åŒ–å±¤ï¼ˆè³‡æ–™åº«ï¼‰å„²å­˜é‡‘é‘°åˆ†ç‰‡å’Œç‹€æ…‹");
    println!("   4. å¯¦ä½œå®‰å…¨çš„é‡‘é‘°ç®¡ç†ï¼ˆHSM æ•´åˆï¼‰");
    println!("   5. åŠ å…¥é‡è©¦æ©Ÿåˆ¶å’ŒéŒ¯èª¤æ¢å¾©é‚è¼¯\n");

    Ok(())
}

// ============================================================================
// æ¸¬è©¦æ¨¡çµ„ (æœªä¾†æ“´å±•)
// ============================================================================

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_frost_signing_flow() {
        // é€™è£¡å¯ä»¥åŠ å…¥å–®å…ƒæ¸¬è©¦
        // ä¾‹å¦‚ï¼šæ¸¬è©¦ä¸åŒæ•¸é‡çš„ç°½ç½²è€…çµ„åˆã€éŒ¯èª¤æƒ…æ³ç­‰
        assert!(main().is_ok());
    }
}

//! # FROST API ç¤ºç¯„å®¢æˆ¶ç«¯
//!
//! æ­¤å®¢æˆ¶ç«¯å±•ç¤ºå¦‚ä½•ä½¿ç”¨ FROST é–€æª»ç°½ç« æœå‹™çš„ HTTP APIã€‚
//!
//! ## é‹è¡Œæ–¹å¼
//! 1. åœ¨ä¸€å€‹çµ‚ç«¯å•Ÿå‹•æœå‹™: `cargo run --release`
//! 2. åœ¨å¦ä¸€å€‹çµ‚ç«¯é‹è¡Œæ­¤å®¢æˆ¶ç«¯: `cargo run --example demo_client`

use serde_json::json;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘   FROST API ç¤ºç¯„å®¢æˆ¶ç«¯                                         â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    let base_url = "http://127.0.0.1:3000";
    let client = reqwest::Client::new();

    // ========================================================================
    // 1. å¥åº·æª¢æŸ¥
    // ========================================================================
    println!("ğŸ“¡ 1. æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹...");

    let health_response = client
        .get(format!("{}/health", base_url))
        .send()
        .await?
        .json::<serde_json::Value>()
        .await?;

    println!("   âœ“ æœå‹™ç‹€æ…‹: {}", health_response["status"]);
    println!("   âœ“ ç°½ç½²è€…æ•¸é‡: {}", health_response["signers_count"]);
    println!();

    // ========================================================================
    // 2. ç²å–ç¾¤çµ„å…¬é‘°
    // ========================================================================
    println!("ğŸ”‘ 2. ç²å–ç¾¤çµ„å…¬é‘°...");

    let pubkey_response = client
        .get(format!("{}/pubkey", base_url))
        .send()
        .await?
        .json::<serde_json::Value>()
        .await?;

    let group_pubkey = pubkey_response["group_public_key"].as_str().unwrap();
    println!("   âœ“ ç¾¤çµ„å…¬é‘°: {}...", &group_pubkey[..32]);
    println!();

    // ========================================================================
    // 3. ä½¿ç”¨é«˜éš API åŸ·è¡Œå®Œæ•´ç°½ç« æµç¨‹
    // ========================================================================
    println!("âœï¸  3. åŸ·è¡Œå®Œæ•´ç°½ç« æµç¨‹ï¼ˆä½¿ç”¨ /sign ç«¯é»ï¼‰...");

    let message = "Transfer 1.5 BTC to bc1q... (tx_hash: 0xabcd1234...)";
    let message_hex = hex::encode(message.as_bytes());

    let sign_request = json!({
        "signer_ids": [1, 2, 3],
        "message": message_hex
    });

    println!("   è¨Šæ¯: {}", message);
    println!("   åƒèˆ‡ç°½ç½²è€…: [1, 2, 3]");
    println!();

    let sign_response = client
        .post(format!("{}/sign", base_url))
        .json(&sign_request)
        .send()
        .await?
        .json::<serde_json::Value>()
        .await?;

    let signature = sign_response["signature"].as_str().unwrap();
    let verified = sign_response["verified"].as_bool().unwrap();

    println!("   âœ“ ç°½ç« å·²ç”Ÿæˆ:");
    println!("      {}", signature);
    println!("   âœ“ é©—è­‰ç‹€æ…‹: {}", if verified { "é€šé âœ“" } else { "å¤±æ•— âœ—" });
    println!();

    // ========================================================================
    // ç¸½çµ
    // ========================================================================
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘   âœ… ç¤ºç¯„å®Œæˆ                                                  â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!();
    println!("ğŸ“Š åŸ·è¡Œæ‘˜è¦:");
    println!("   â€¢ é€šè¨Šè¼ªæ¬¡: 2 (FROST å”è­°)");
    println!("   â€¢ åƒèˆ‡ç°½ç½²è€…: 3/5");
    println!("   â€¢ ç°½ç« é©—è­‰: âœ“ æˆåŠŸ");
    println!();
    println!("ğŸ’¡ ä¸‹ä¸€æ­¥æ¢ç´¢:");
    println!("   â€¢ å˜—è©¦æ‰‹å‹•èª¿ç”¨ /signer/:id/round1 å’Œ round2 ç«¯é»");
    println!("   â€¢ æ¸¬è©¦ä¸åŒçš„ç°½ç½²è€…çµ„åˆ (ä¾‹å¦‚ [2, 3, 4])");
    println!("   â€¢ æŸ¥çœ‹æœå‹™æ—¥èªŒäº†è§£å…§éƒ¨æµç¨‹");
    println!();

    Ok(())
}
